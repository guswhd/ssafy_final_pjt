<!DOCTYPE html>
<html>
<head>
    <title>SSAFY Visual Radar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { background-color: #121212; color: white; text-align: center; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; }
        
        /* ÌÉÄÏù¥ÌãÄ Î∞è Ï†ïÎ≥¥Ï∞Ω */
        h2 { margin: 15px 0 5px 0; font-size: 18px; color: #ddd; }
        
        /* Ï¢åÌëú Ï†ïÎ≥¥ (Î†àÏù¥Îçî Î∞îÍπ•ÏúºÎ°ú Î∫å) */
        .info-panel {
            background-color: #1e1e1e;
            color: #00ff00;
            padding: 8px 20px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 10px;
            font-family: monospace;
            font-size: 16px;
            border: 1px solid #333;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        /* Î†àÏù¥Îçî Îßµ Ïä§ÌÉÄÏùº */
        #radar-container {
            position: relative;
            margin: 0 auto 20px auto;
            width: 340px;
            height: 340px;
            background-color: #1e1e1e;
            border-radius: 50%;
            border: 3px solid #444;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8), 0 0 15px rgba(0, 255, 0, 0.2);
            overflow: hidden;
        }
        canvas { display: block; }
        
        /* Ïª®Ìä∏Î°§Îü¨ Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .controls {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: absolute; bottom: 20px; left: 0; right: 0;
        }
        .row { display: flex; justify-content: center; margin: 4px; }
        button {
            width: 55px; height: 55px; margin: 4px;
            font-size: 22px; border-radius: 12px; border: none;
            background-color: #333; color: white;
            box-shadow: 0 4px #000; transition: transform 0.1s;
        }
        button:active { transform: translateY(4px); box-shadow: 0 0 #000; }
        .btn-stop { background-color: #d32f2f; width: 65px; height: 65px; font-weight: bold; font-size: 14px; }
        .btn-dir { background-color: #1565C0; }
    </style>
</head>
<body>

    <h2>ü§ñ SSAFY Robot Radar</h2>

    <div class="info-panel">
        X: <span id="val_x">0.00</span>m &nbsp;|&nbsp; Y: <span id="val_y">0.00</span>m &nbsp;|&nbsp; <span id="val_head">0</span>¬∞
    </div>

    <div id="radar-container">
        <canvas id="mapCanvas" width="340" height="340"></canvas>
    </div>

    <div class="controls">
        <div class="row">
            <button class="btn-dir" ontouchstart="send('upleft')" onmousedown="send('upleft')">‚Üñ</button>
            <button class="btn-dir" ontouchstart="send('up')" onmousedown="send('up')">‚ñ≤</button>
            <button class="btn-dir" ontouchstart="send('upright')" onmousedown="send('upright')">‚Üó</button>
        </div>
        <div class="row">
            <button class="btn-dir" ontouchstart="send('left')" onmousedown="send('left')">‚óÄ</button>
            <button class="btn-stop" ontouchstart="send('stop')" onmousedown="send('stop')">STOP</button>
            <button class="btn-dir" ontouchstart="send('right')" onmousedown="send('right')">‚ñ∂</button>
        </div>
        <div class="row">
            <button class="btn-dir" ontouchstart="send('downleft')" onmousedown="send('downleft')">‚Üô</button>
            <button class="btn-dir" ontouchstart="send('down')" onmousedown="send('down')">‚ñº</button>
            <button class="btn-dir" ontouchstart="send('downright')" onmousedown="send('downright')">‚Üò</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('mapCanvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        const cx = width / 2;
        const cy = height / 2;
        const scale = 50; // 1ÎØ∏ÌÑ∞ = 50ÌîΩÏÖÄ

        let robot = { x: 0, y: 0, head: 0 };

        function draw() {
            ctx.clearRect(0, 0, width, height);

            // (1) Í∑∏Î¶¨Îìú (Î∞∞Í≤Ω)
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for(let x = cx % scale; x < width; x += scale) { ctx.moveTo(x, 0); ctx.lineTo(x, height); }
            for(let y = cy % scale; y < height; y += scale) { ctx.moveTo(0, y); ctx.lineTo(width, y); }
            ctx.stroke();

            // (2) Ïã≠ÏûêÏÑ† (ÏõêÏ†ê)
            ctx.strokeStyle = '#555';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(cx, 0); ctx.lineTo(cx, height);
            ctx.moveTo(0, cy); ctx.lineTo(width, cy);
            ctx.stroke();

            // --- Î°úÎ¥á Ï¢åÌëú Í≥ÑÏÇ∞ ---
            // ROS Ï¢åÌëúÍ≥Ñ(X:Ïïû, Y:Ï¢å) -> Ï∫îÎ≤ÑÏä§(X:Ïö∞, Y:Ìïò) Î≥ÄÌôò
            let screenX = cx - (robot.y * scale);
            let screenY = cy - (robot.x * scale);

            ctx.save();
            ctx.translate(screenX, screenY);
            ctx.rotate(-robot.head * Math.PI / 180); 

            // (3) ÏãúÏïºÍ∞Å (FOV) Í∑∏Î¶¨Í∏∞ - [Ï∂îÍ∞ÄÎêú Î∂ÄÎ∂Ñ]
            // Î∂ÄÏ±ÑÍº¥ Î™®Ïñë (90ÎèÑ ÌôîÍ∞Å Í∞ÄÏ†ï)
            ctx.beginPath();
            ctx.moveTo(0, 0); // Î°úÎ¥á Ï§ëÏã¨ÏóêÏÑú ÏãúÏûë
            // -135ÎèÑ ~ -45ÎèÑ (ÏúÑÏ™Ω Î∞©Ìñ•Ïù¥ -90ÎèÑÏù¥ÎØÄÎ°ú Ï¢åÏö∞ 45ÎèÑÏî©)
            ctx.arc(0, 0, 80, -Math.PI * 0.75, -Math.PI * 0.25); 
            ctx.closePath();
            
            // Í∑∏ÎùºÎç∞Ïù¥ÏÖò Ìö®Í≥º (Ïπ¥Î©îÎùº Î∂àÎπõÏ≤òÎüº)
            let grd = ctx.createRadialGradient(0, 0, 10, 0, 0, 80);
            grd.addColorStop(0, "rgba(255, 255, 0, 0.4)"); // Ï§ëÏã¨ÏùÄ Î∞ùÏùÄ ÎÖ∏Îûë
            grd.addColorStop(1, "rgba(255, 255, 0, 0.0)"); // ÎÅùÏùÄ Ìà¨Î™Ö
            ctx.fillStyle = grd;
            ctx.fill();

            // (4) Î°úÎ¥á Î≥∏Ï≤¥ (ÌôîÏÇ¥Ìëú)
            ctx.fillStyle = '#00ff00';
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#00ff00';
            ctx.beginPath();
            ctx.moveTo(0, -12); // Î®∏Î¶¨ (Ï°∞Í∏à Îçî Í∏∏Í≤å)
            ctx.lineTo(9, 10);
            ctx.lineTo(0, 6);
            ctx.lineTo(-9, 10);
            ctx.closePath();
            ctx.fill();
            
            ctx.restore();
        }

        function send(act) {
            fetch('/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: act })
            });
            if (navigator.vibrate) navigator.vibrate(30);
        }

        setInterval(() => {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    robot.x = data.x;
                    robot.y = data.y;
                    robot.head = data.head;
                    
                    document.getElementById('val_x').innerText = robot.x.toFixed(2);
                    document.getElementById('val_y').innerText = robot.y.toFixed(2);
                    document.getElementById('val_head').innerText = robot.head;
                    draw();
                });
        }, 100);

        draw();
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'w') send('up');
            else if (e.key === 's') send('down');
            else if (e.key === 'a') send('left');
            else if (e.key === 'd') send('right');
            else if (e.key === ' ') send('stop');
        });
    </script>
</body>
</html>
